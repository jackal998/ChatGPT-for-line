steps:
  - id: "build image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: 'bash'
    args: ["-c", "docker build --build-arg MASTER_KEY=$$RAILS_MASTER_KEY -t $_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA . "]
    secretEnv: ["RAILS_MASTER_KEY"]

  - id: "push image"
    name: "gcr.io/cloud-builders/docker"
    args: ["push", "$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA"]

options:
  substitutionOption: ALLOW_LOOSE

substitutions:
  REPO_NAME: chatgpt-in-line
  _GCR_HOSTNAME: us.gcr.io
  _SECRET_NAME: rails-master-key

availableSecrets:
  secretManager:
  - versionName: projects/${PROJECT_ID}/secrets/${_SECRET_NAME}/versions/latest
    env: RAILS_MASTER_KEY

images:
  - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME:$COMMIT_SHA'
